<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Existing Infrastructure Example

This example demonstrates how to deploy Azure CloudShell with Virtual Network integration using the **data source pattern** to reference existing infrastructure.

## Overview

This example shows the pattern for integrating CloudShell into environments where infrastructure already exists. It demonstrates:

- ✅ Using **data sources** to reference existing Resource Groups and Virtual Networks
- ✅ Deploying CloudShell infrastructure into an existing VNet
- ✅ Creating subnets within existing network address space
- ✅ The recommended approach for brownfield Azure environments

> **Note**: For demonstration purposes, this example creates a "simulated existing" VNet, then references it via data sources. In a real scenario, you would only use the data source blocks to reference truly pre-existing infrastructure.

## What This Example Demonstrates

This example pattern shows how to:

1. **Reference existing infrastructure** using `data` blocks (Resource Group, VNet)
2. **Deploy CloudShell resources** into the existing VNet
3. **Create new subnets** within available address space
4. **Use randomized names** for globally unique resources (storage account, relay namespace)

## Real-World Usage

In a production environment, you would:

1. **Remove the resource creation blocks** (the `resource "azurerm_resource_group"` and `resource "azurerm_virtual_network"` blocks)
2. **Keep only the data source blocks** pointing to your actual existing resources
3. **Update the data source names** to match your existing resource names
4. **Verify subnet address availability** in your VNet before deploying

## Example: Adapting for Your Environment

```hcl
# Reference YOUR existing Resource Group
data "azurerm_resource_group" "existing" {
  name = "my-production-rg"  # Your actual RG name
}

# Reference YOUR existing Virtual Network
data "azurerm_virtual_network" "existing" {
  name                = "my-production-vnet"  # Your actual VNet name
  resource_group_name = "my-production-rg"
}

# Then use the module as shown in the example
module "cloudshell_vnet" {
  source = "Azure/avm-ptn-cloudshell-vnet/azurerm"
  virtual_network_name                = data.azurerm_virtual_network.existing.name
  virtual_network_resource_group_name = data.azurerm_virtual_network.existing.resource_group_name
  # ... rest of configuration
}
```

## Deployment

This example is fully self-contained and deployable as-is:

```bash
terraform init
terraform plan
terraform apply
```

## Key Differences from Default Example

| Aspect | Default Example | Existing Infrastructure Example |
|--------|----------------|--------------------------------|
| **VNet Creation** | Creates new VNet | References existing VNet via data source |
| **Use Case** | Greenfield deployment | Brownfield/existing environment |
| **Pattern** | Direct resource creation | Data source → Module pattern |
| **Flexibility** | Quick start | Production-ready pattern |

## When to Use This Pattern

Use this **existing-infrastructure pattern** when:
- ✅ You have an established Azure Landing Zone
- ✅ VNets and Resource Groups are already deployed
- ✅ You need to follow organizational standards for infrastructure references
- ✅ You want to avoid creating duplicate base infrastructure

Use the **default example** when:
- ✅ Starting a new project from scratch
- ✅ Testing or proof-of-concept scenarios
- ✅ You want a quick, self-contained deployment

```hcl
terraform {
  required_version = ">= 1.9"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
  }
}

provider "azurerm" {
  features {}
}

# =========================================
# Create "Existing" Infrastructure for Demo
# =========================================
# This example demonstrates using the module with existing infrastructure
# In a real scenario, these resources would already exist

## Section to provide a random Azure region
module "regions" {
  source  = "Azure/avm-utl-regions/azurerm"
  version = "~> 0.1"
}

resource "random_integer" "region_index" {
  max = length(module.regions.regions) - 1
  min = 0
}
## End of section to provide a random Azure region

# Naming module for unique names
module "naming" {
  source  = "Azure/naming/azurerm"
  version = "~> 0.3"
}

# Create "existing" Resource Group (simulating pre-existing infrastructure)
resource "azurerm_resource_group" "existing" {
  location = module.regions.regions[random_integer.region_index.result].name
  name     = "${module.naming.resource_group.name_unique}-existing"
}

# Create "existing" Virtual Network (simulating pre-existing infrastructure)
resource "azurerm_virtual_network" "existing" {
  location            = azurerm_resource_group.existing.location
  name                = "${module.naming.virtual_network.name_unique}-existing"
  resource_group_name = azurerm_resource_group.existing.name
  address_space       = ["10.0.0.0/16"]
}

# Generate unique suffix for storage and relay names
resource "random_string" "suffix" {
  length  = 8
  lower   = true
  numeric = true
  special = false
  upper   = false
}

# =========================================
# Data Sources - Reference "Existing" Resources
# =========================================
# In a real scenario, you would use data sources to reference
# truly existing resources instead of creating them above

data "azurerm_resource_group" "existing" {
  name = azurerm_resource_group.existing.name

  depends_on = [azurerm_resource_group.existing]
}

data "azurerm_virtual_network" "existing" {
  name                = azurerm_virtual_network.existing.name
  resource_group_name = azurerm_resource_group.existing.name

  depends_on = [azurerm_virtual_network.existing]
}

# =========================================
# CloudShell VNet Module
# =========================================

# Deploy CloudShell with "existing" VNet
# This demonstrates the data source pattern for referencing existing infrastructure
module "cloudshell_vnet" {
  source = "../../"

  # Subnet Configuration
  # These address ranges are available within the 10.0.0.0/16 VNet created above
  container_subnet_address_prefix = "10.0.1.0/28"
  # Relay Namespace Configuration (unique name required)
  relay_namespace_name        = "cloudshell-relay-${random_string.suffix.result}"
  relay_subnet_address_prefix = "10.0.1.16/28"
  # Storage Account Configuration (unique names required)
  storage_account_name          = "cloudshell${random_string.suffix.result}"
  storage_subnet_address_prefix = "10.0.1.32/28"
  # Reference existing Virtual Network via data source
  virtual_network_name                = data.azurerm_virtual_network.existing.name
  virtual_network_resource_group_name = data.azurerm_virtual_network.existing.resource_group_name
  # Enable telemetry (AVM requirement)
  enable_telemetry = var.enable_telemetry
  # Location (inherited from VNet)
  location = data.azurerm_virtual_network.existing.location
  # Tags
  tags = {
    Environment = "Example"
    Purpose     = "Existing-Infrastructure-Demo"
  }
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

## Resources

The following resources are used by this module:

- [azurerm_resource_group.existing](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_virtual_network.existing](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [random_string.suffix](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) (resource)
- [azurerm_resource_group.existing](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) (data source)
- [azurerm_virtual_network.existing](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/virtual_network) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_enable_telemetry"></a> [enable\_telemetry](#input\_enable\_telemetry)

Description: This variable controls whether or not telemetry is enabled for the module.  
For more information see <https://aka.ms/avm/telemetryinfo\>.  
If it is set to false, then no telemetry will be collected.

Type: `bool`

Default: `true`

## Outputs

The following outputs are exported:

### <a name="output_container_subnet_id"></a> [container\_subnet\_id](#output\_container\_subnet\_id)

Description: The resource ID of the CloudShell container subnet.

### <a name="output_existing_resource_group_name"></a> [existing\_resource\_group\_name](#output\_existing\_resource\_group\_name)

Description: The name of the existing resource group.

### <a name="output_existing_virtual_network_address_space"></a> [existing\_virtual\_network\_address\_space](#output\_existing\_virtual\_network\_address\_space)

Description: The address space of the existing virtual network.

### <a name="output_existing_virtual_network_id"></a> [existing\_virtual\_network\_id](#output\_existing\_virtual\_network\_id)

Description: The resource ID of the existing virtual network.

### <a name="output_location"></a> [location](#output\_location)

Description: The Azure region where resources were deployed.

### <a name="output_network_profile_id"></a> [network\_profile\_id](#output\_network\_profile\_id)

Description: The resource ID of the Network Profile for CloudShell.

### <a name="output_network_profile_name"></a> [network\_profile\_name](#output\_network\_profile\_name)

Description: The name of the Network Profile.

### <a name="output_private_endpoint_id"></a> [private\_endpoint\_id](#output\_private\_endpoint\_id)

Description: The resource ID of the Private Endpoint for the Relay Namespace.

### <a name="output_relay_namespace_id"></a> [relay\_namespace\_id](#output\_relay\_namespace\_id)

Description: The resource ID of the Azure Relay Namespace.

### <a name="output_relay_namespace_name"></a> [relay\_namespace\_name](#output\_relay\_namespace\_name)

Description: The name of the Azure Relay Namespace.

### <a name="output_relay_subnet_id"></a> [relay\_subnet\_id](#output\_relay\_subnet\_id)

Description: The resource ID of the relay subnet.

### <a name="output_storage_account_id"></a> [storage\_account\_id](#output\_storage\_account\_id)

Description: The resource ID of the Storage Account.

### <a name="output_storage_account_name"></a> [storage\_account\_name](#output\_storage\_account\_name)

Description: The name of the Storage Account for CloudShell.

### <a name="output_storage_subnet_id"></a> [storage\_subnet\_id](#output\_storage\_subnet\_id)

Description: The resource ID of the storage subnet.

## Modules

The following Modules are called:

### <a name="module_cloudshell_vnet"></a> [cloudshell\_vnet](#module\_cloudshell\_vnet)

Source: ../../

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: ~> 0.3

### <a name="module_regions"></a> [regions](#module\_regions)

Source: Azure/avm-utl-regions/azurerm

Version: ~> 0.1

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft’s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->