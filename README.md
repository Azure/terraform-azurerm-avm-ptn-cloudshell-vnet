<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# terraform-azurerm-avm-ptn-cloudshell-vnet

This Azure Verified Module (AVM) pattern deploys Azure CloudShell with Virtual Network integration, providing a secure and compliant way to use CloudShell within your private network infrastructure.

## Features

This module creates and configures the following resources for CloudShell VNet integration:

- **3 Dedicated Subnets** with appropriate configurations:
  - Container subnet with delegation to `Microsoft.ContainerInstance/containerGroups`
  - Relay subnet for private endpoint connectivity
  - Storage subnet with storage service endpoints
- **Network Security Groups** for each subnet
- **Storage Account** with security compliance:
  - Minimum TLS version 1.2
  - HTTPS traffic only
  - Network rules to restrict access to CloudShell subnets
  - File share for persistent CloudShell user data
- **Azure Relay Namespace** for secure communication
- **Private Endpoint** for the Relay Namespace
- **Network Profile** for container instances
- **Optional Private DNS Zone** integration for private endpoint name resolution

## Benefits

- ✅ **Security Compliance**: Enforces TLS 1.2 and HTTPS-only traffic
- ✅ **Network Isolation**: CloudShell operates within your private virtual network
- ✅ **Azure Policy Compatible**: Supports enterprise governance requirements
- ✅ **Flexible Configuration**: Works with existing VNets and Private DNS Zones
- ✅ **AVM Compliant**: Follows Azure Verified Modules specifications

## Prerequisites

Before using this module, you must have:

1. An existing **Virtual Network** in Azure
2. Sufficient address space for three /28 subnets (minimum recommended)
3. Appropriate Azure RBAC permissions to create resources
4. (Optional) An existing Private DNS Zone for `privatelink.servicebus.windows.net`

## Usage

### Basic Usage

```hcl
module "cloudshell_vnet" {
  source  = "Azure/avm-ptn-cloudshell-vnet/azurerm"
  version = "~> 1.0"

  # Existing Virtual Network
  virtual_network_name                = "my-vnet"
  virtual_network_resource_group_name = "my-rg"

  # Storage Account Configuration
  storage_account_name = "cloudshellst123"  # Must be globally unique
  # Relay Namespace
  relay_namespace_name = "cloudshell-relay"

  # Subnet Configuration
  container_subnet_address_prefix = "10.0.1.0/28"
  relay_subnet_address_prefix     = "10.0.1.16/28"
  storage_subnet_address_prefix   = "10.0.1.32/28"
}
```

### Usage with Existing Private DNS Zone

```hcl
module "cloudshell_vnet" {
  source  = "Azure/avm-ptn-cloudshell-vnet/azurerm"
  version = "~> 1.0"

  # Existing Virtual Network
  virtual_network_name                = "my-vnet"
  virtual_network_resource_group_name = "my-rg"

  # Storage Account Configuration
  storage_account_name = "cloudshellst123"
  # Relay Namespace
  relay_namespace_name = "cloudshell-relay"

  # Subnet Configuration
  container_subnet_address_prefix = "10.0.1.0/28"
  relay_subnet_address_prefix     = "10.0.1.16/28"
  storage_subnet_address_prefix   = "10.0.1.32/28"

  # Existing Private DNS Zone
  private_dns_zone_id = "/subscriptions/xxxx/resourceGroups/xxxx/providers/Microsoft.Network/privateDnsZones/privatelink.servicebus.windows.net"
}
```

## Important Notes

### Subnet Sizing

Microsoft recommends **minimum /28 subnets** for each of the three required subnets. Larger subnets may be needed depending on expected CloudShell usage.

### Deletion Considerations

When destroying resources, the Network Profile may fail to delete if CloudShell container instances are still active. After disconnecting from CloudShell, Azure automatically deletes the container instance, but this can take **30 minutes to several hours**. Monitor the Network Profile's activity logs for the "Removes Containers" operation before attempting to delete.

### Private DNS Zone

If you provide an existing Private DNS Zone ID, ensure:
- The zone is for `privatelink.servicebus.windows.net`
- It is linked to the Virtual Network
- You have permissions to create DNS records

If no Private DNS Zone is provided, name resolution for the private endpoint will need to be managed separately (e.g., via Azure Policy or manual DNS configuration).

## Examples

See the [examples](./examples/) directory for complete usage examples:

- [**default**](./examples/default/) - Basic CloudShell VNet deployment with a new VNet

## Contributing

This module follows the Azure Verified Modules (AVM) specifications. Contributions are welcome! Please see the [CONTRIBUTING.md](CONTRIBUTING.md) file for details.

## References

- [Azure CloudShell in a Virtual Network Documentation](https://learn.microsoft.com/en-us/azure/cloud-shell/vnet/overview)
- [Azure Verified Modules](https://aka.ms/avm)
- [Module Issue #1811](https://github.com/Azure/Azure-Verified-Modules/issues/1811)

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9, < 2.0)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.4)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_modtm"></a> [modtm](#requirement\_modtm) (~> 0.3)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

## Resources

The following resources are used by this module:

- [azurerm_network_profile.cloudshell](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_profile) (resource)
- [azurerm_relay_namespace.cloudshell](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/relay_namespace) (resource)
- [azurerm_subnet.container](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) (resource)
- [azurerm_subnet.relay](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) (resource)
- [azurerm_subnet.storage](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) (resource)
- [azurerm_subnet_network_security_group_association.container](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_network_security_group_association) (resource)
- [azurerm_subnet_network_security_group_association.relay](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_network_security_group_association) (resource)
- [azurerm_subnet_network_security_group_association.storage](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_network_security_group_association) (resource)
- [modtm_telemetry.telemetry](https://registry.terraform.io/providers/azure/modtm/latest/docs/resources/telemetry) (resource)
- [random_uuid.telemetry](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/uuid) (resource)
- [azapi_client_config.telemetry](https://registry.terraform.io/providers/Azure/azapi/latest/docs/data-sources/client_config) (data source)
- [azurerm_virtual_network.vnet](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/virtual_network) (data source)
- [modtm_module_source.telemetry](https://registry.terraform.io/providers/azure/modtm/latest/docs/data-sources/module_source) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

The following input variables are required:

### <a name="input_container_subnet_address_prefix"></a> [container\_subnet\_address\_prefix](#input\_container\_subnet\_address\_prefix)

Description: Address prefix for the container subnet (minimum /28 recommended).

Type: `string`

### <a name="input_location"></a> [location](#input\_location)

Description: Azure region where the CloudShell resources should be deployed. If not specified, uses the location of the existing VNet.

Type: `string`

### <a name="input_relay_namespace_name"></a> [relay\_namespace\_name](#input\_relay\_namespace\_name)

Description: Name of the Azure Relay Namespace for CloudShell communication.

Type: `string`

### <a name="input_relay_subnet_address_prefix"></a> [relay\_subnet\_address\_prefix](#input\_relay\_subnet\_address\_prefix)

Description: Address prefix for the relay subnet (minimum /28 recommended).

Type: `string`

### <a name="input_storage_account_name"></a> [storage\_account\_name](#input\_storage\_account\_name)

Description: Name of the Storage Account for CloudShell. Must be globally unique, 3-24 characters, lowercase letters and numbers only.

Type: `string`

### <a name="input_storage_subnet_address_prefix"></a> [storage\_subnet\_address\_prefix](#input\_storage\_subnet\_address\_prefix)

Description: Address prefix for the storage subnet (minimum /28 recommended).

Type: `string`

### <a name="input_virtual_network_name"></a> [virtual\_network\_name](#input\_virtual\_network\_name)

Description: Name of the existing virtual network where CloudShell subnets will be created.

Type: `string`

### <a name="input_virtual_network_resource_group_name"></a> [virtual\_network\_resource\_group\_name](#input\_virtual\_network\_resource\_group\_name)

Description: Name of the resource group containing the existing virtual network.

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_container_subnet_name"></a> [container\_subnet\_name](#input\_container\_subnet\_name)

Description: Name of the subnet for CloudShell container instances.

Type: `string`

Default: `"cloudshell-containers"`

### <a name="input_enable_telemetry"></a> [enable\_telemetry](#input\_enable\_telemetry)

Description: This variable controls whether or not telemetry is enabled for the module.  
For more information see <https://aka.ms/avm/telemetryinfo>.  
If it is set to false, then no telemetry will be collected.

Type: `bool`

Default: `true`

### <a name="input_file_share_name"></a> [file\_share\_name](#input\_file\_share\_name)

Description: Name of the File Share within the Storage Account for CloudShell user data.

Type: `string`

Default: `"cloudshell"`

### <a name="input_file_share_quota_gb"></a> [file\_share\_quota\_gb](#input\_file\_share\_quota\_gb)

Description: The maximum size of the file share in gigabytes. Minimum is 6 GB for CloudShell.

Type: `number`

Default: `6`

### <a name="input_private_dns_zone_id"></a> [private\_dns\_zone\_id](#input\_private\_dns\_zone\_id)

Description: Resource ID of an existing Private DNS Zone for privatelink.servicebus.windows.net. If not provided, DNS zone group will not be configured.

Type: `string`

Default: `null`

### <a name="input_private_endpoint_name"></a> [private\_endpoint\_name](#input\_private\_endpoint\_name)

Description: Name of the Private Endpoint for Azure Relay.

Type: `string`

Default: `"cloudshell-relay-pe"`

### <a name="input_relay_subnet_name"></a> [relay\_subnet\_name](#input\_relay\_subnet\_name)

Description: Name of the subnet for Azure Relay private endpoint.

Type: `string`

Default: `"cloudshell-relay"`

### <a name="input_storage_account_network_bypass"></a> [storage\_account\_network\_bypass](#input\_storage\_account\_network\_bypass)

Description: Specifies whether traffic is bypassed for Logging/Metrics/AzureServices. Valid options are any combination of Logging, Metrics, AzureServices, or None.

Type: `set(string)`

Default: `[]`

### <a name="input_storage_account_replication_type"></a> [storage\_account\_replication\_type](#input\_storage\_account\_replication\_type)

Description: The replication type of the storage account. Valid options are GRS, RAGRS, ZRS, GZRS, RAGZRS. LRS is not recommended for production.

Type: `string`

Default: `"ZRS"`

### <a name="input_storage_account_tier"></a> [storage\_account\_tier](#input\_storage\_account\_tier)

Description: The tier of the storage account. Valid options are Standard or Premium.

Type: `string`

Default: `"Standard"`

### <a name="input_storage_subnet_name"></a> [storage\_subnet\_name](#input\_storage\_subnet\_name)

Description: Name of the subnet for storage service endpoints.

Type: `string`

Default: `"cloudshell-storage"`

### <a name="input_tags"></a> [tags](#input\_tags)

Description: Map of tags to assign to the CloudShell resources.

Type: `map(string)`

Default: `null`

## Outputs

The following outputs are exported:

### <a name="output_container_nsg_id"></a> [container\_nsg\_id](#output\_container\_nsg\_id)

Description: The resource ID of the Network Security Group for the container subnet.

### <a name="output_container_subnet_id"></a> [container\_subnet\_id](#output\_container\_subnet\_id)

Description: The resource ID of the container subnet for CloudShell instances.

### <a name="output_file_share_id"></a> [file\_share\_id](#output\_file\_share\_id)

Description: The resource ID of the file share.

### <a name="output_file_share_name"></a> [file\_share\_name](#output\_file\_share\_name)

Description: The name of the file share for CloudShell user data.

### <a name="output_location"></a> [location](#output\_location)

Description: The Azure region where the resources were deployed.

### <a name="output_network_profile_id"></a> [network\_profile\_id](#output\_network\_profile\_id)

Description: The resource ID of the Network Profile for CloudShell container instances.

### <a name="output_network_profile_name"></a> [network\_profile\_name](#output\_network\_profile\_name)

Description: The name of the Network Profile.

### <a name="output_private_endpoint_id"></a> [private\_endpoint\_id](#output\_private\_endpoint\_id)

Description: The resource ID of the Private Endpoint for the Relay Namespace.

### <a name="output_private_endpoint_ip_address"></a> [private\_endpoint\_ip\_address](#output\_private\_endpoint\_ip\_address)

Description: The private IP address of the Private Endpoint.

### <a name="output_relay_namespace_id"></a> [relay\_namespace\_id](#output\_relay\_namespace\_id)

Description: The resource ID of the Azure Relay Namespace.

### <a name="output_relay_namespace_name"></a> [relay\_namespace\_name](#output\_relay\_namespace\_name)

Description: The name of the Azure Relay Namespace.

### <a name="output_relay_nsg_id"></a> [relay\_nsg\_id](#output\_relay\_nsg\_id)

Description: The resource ID of the Network Security Group for the relay subnet.

### <a name="output_relay_subnet_id"></a> [relay\_subnet\_id](#output\_relay\_subnet\_id)

Description: The resource ID of the relay subnet for private endpoints.

### <a name="output_resource_group_name"></a> [resource\_group\_name](#output\_resource\_group\_name)

Description: The name of the resource group containing the CloudShell resources.

### <a name="output_resource_id"></a> [resource\_id](#output\_resource\_id)

Description: The resource ID of the primary resource (Network Profile) for CloudShell VNet integration.

### <a name="output_storage_account_id"></a> [storage\_account\_id](#output\_storage\_account\_id)

Description: The resource ID of the Storage Account for CloudShell.

### <a name="output_storage_account_name"></a> [storage\_account\_name](#output\_storage\_account\_name)

Description: The name of the Storage Account for CloudShell.

### <a name="output_storage_account_primary_blob_endpoint"></a> [storage\_account\_primary\_blob\_endpoint](#output\_storage\_account\_primary\_blob\_endpoint)

Description: The primary blob endpoint of the Storage Account.

### <a name="output_storage_nsg_id"></a> [storage\_nsg\_id](#output\_storage\_nsg\_id)

Description: The resource ID of the Network Security Group for the storage subnet.

### <a name="output_storage_subnet_id"></a> [storage\_subnet\_id](#output\_storage\_subnet\_id)

Description: The resource ID of the storage subnet.

### <a name="output_virtual_network_id"></a> [virtual\_network\_id](#output\_virtual\_network\_id)

Description: The resource ID of the Virtual Network.

## Modules

The following Modules are called:

### <a name="module_nsg_container"></a> [nsg\_container](#module\_nsg\_container)

Source: Azure/avm-res-network-networksecuritygroup/azurerm

Version: ~> 0.3

### <a name="module_nsg_relay"></a> [nsg\_relay](#module\_nsg\_relay)

Source: Azure/avm-res-network-networksecuritygroup/azurerm

Version: ~> 0.3

### <a name="module_nsg_storage"></a> [nsg\_storage](#module\_nsg\_storage)

Source: Azure/avm-res-network-networksecuritygroup/azurerm

Version: ~> 0.3

### <a name="module_private_endpoint"></a> [private\_endpoint](#module\_private\_endpoint)

Source: Azure/avm-res-network-privateendpoint/azurerm

Version: ~> 0.1

### <a name="module_storage_account"></a> [storage\_account](#module\_storage\_account)

Source: Azure/avm-res-storage-storageaccount/azurerm

Version: ~> 0.4

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft’s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->